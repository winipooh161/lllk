<?php
namespace App\Http\Controllers;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;
use Illuminate\Http\Request;
use App\Models\Common;
use App\Models\Deal;
use App\Models\Commercial;
use App\Models\User; // Добавляем импорт модели User
use PDF; // Добавляем в начало файла
use Illuminate\Support\Facades\Log;

class BrifsController extends Controller
{
    /**
     * BrifsController constructor.
     */
    public function __construct()
    {
        $this->middleware('auth');
    }
    /**
     * Показать страницу с брифами.
     *
     * @return \Illuminate\Contracts\View\View
     */
    public function index()
    {
        $title_site = "Ваши брифы | Личный кабинет Экспресс-дизайн";
        $user = Auth::user();
    
        // Заголовки страниц для типов брифов
        $pageTitlesCommon = [
            'Общая информация',
            'Интерьер: стиль и предпочтения',
            'Пожелания по помещениям',
            'Пожелания по отделке помещений',
            'Пожелания по оснащению помещений',
        ];
    
        $pageTitlesCommercial = [
            'Зоны и их функционал', 'Метраж зон', 'Зоны и их ', 'Мебилировка зон',
            'Отделочные материалы', 'Освещение зон', 'Кондиционирование',
            'Напольное покрытие зон', 'Отделка стен зон', 'Отделка потолков зон',
            'Категорически неприемлемо', 'Бюджет на помещения', 'Пожелания',
        ];
    
        // Получаем брифы пользователя
        $activeCommon = Common::where('user_id', auth()->id())->where('status', 'Активный')->get();
        $inactiveCommon = Common::where('user_id', auth()->id())->where('status', 'Завершенный')->get();
        $activeCommercial = Commercial::where('user_id', auth()->id())->where('status', 'Активный')->get();
        $inactiveCommercial = Commercial::where('user_id', auth()->id())->where('status', 'Завершенный')->get();
    
        // Объединяем активные брифы в один массив и сортируем по дате создания (новые сверху)
        $activeBrifs = $activeCommon->merge($activeCommercial)->sortByDesc('created_at');
    
        // Объединяем неактивные брифы и сортируем аналогично
        $inactiveBrifs = $inactiveCommon->merge($inactiveCommercial)->sortByDesc('created_at');
    
        return view('brifs', compact(
            'activeBrifs', 'inactiveBrifs', 'pageTitlesCommercial', 'pageTitlesCommon', 'user', 'title_site'
        ));
    }
    
    /**
     * Отображение формы создания брифов.
     *
     * @return \Illuminate\Contracts\View\View
     */
    public function common_create()
    {$user = Auth::user();
        $title_site = "Создать Общий бриф | Личный кабинет Экспресс-дизайн";
        return view('common.create',compact('title_site', 'user'));
    }
    public function common_store(Request $request)
    {
        $user = Auth::user();
        
        // Создаем бриф
        $brif = Common::create([
            'title' => 'Общий бриф',
            'description' => 'Общий бриф представляет собой структурированный опрос, направленный на выявление базовых предпочтений и потребностей клиента. Он включает вопросы о личных предпочтениях, функциональных особенностях помещения, количестве жильцов, а также об основных стилевых решениях. Заполнение этого брифа позволяет нам лучше понять ваш образ жизни и создать проект, который гармонично объединит практичность, уют и эстетическое единство интерьера.',
            'status' => 'Активный',
            'article' => Str::random(15), 
            'user_id' => $user->id,
        ]);
        
        // Ищем сделки по номеру телефона пользователя без привязанных брифов любого типа
        if ($user->phone) {
            // Нормализуем телефон для поиска (убираем все нецифровые символы)
            $normalizedPhone = preg_replace('/\D/', '', $user->phone);
            
            Log::info('Поиск сделки для привязки общего брифа', [
                'user_id' => $user->id,
                'normalized_phone' => $normalizedPhone,
                'brief_id' => $brif->id
            ]);
            
            // Вместо использования REGEXP, получим все сделки без привязанных брифов ЛЮБОГО ТИПА
            $potentialDeals = Deal::whereNull('common_id')
                             ->whereNull('commercial_id') // Добавляем проверку на отсутствие коммерческого брифа
                             ->get();
        
            // Ищем сделку с совпадающим номером телефона
            $availableDeal = null;
            foreach ($potentialDeals as $deal) {
                $dealPhoneNormalized = preg_replace('/\D/', '', $deal->client_phone);
                
                // Сравниваем последние N цифр телефона (например, 10 для России)
                $lastDigitsToCompare = 10;
                $dealLastDigits = substr($dealPhoneNormalized, -$lastDigitsToCompare);
                $userLastDigits = substr($normalizedPhone, -$lastDigitsToCompare);
                
                if ($dealLastDigits == $userLastDigits && strlen($dealLastDigits) == $lastDigitsToCompare) {
                    $availableDeal = $deal;
                    break;
                }
            }
            
            // Если нашли подходящую сделку, привязываем к ней бриф
            if ($availableDeal) {
                // Используем транзакцию для атомарного обновления
                \DB::transaction(function() use ($availableDeal, $brif) {
                    // Привязываем бриф к сделке
                    $availableDeal->common_id = $brif->id;
                    $availableDeal->save();
                    
                    // Привязываем сделку к брифу
                    $brif->deal_id = $availableDeal->id;
                    $brif->save();
                });
                
                // Логируем привязку
                Log::info('Общий бриф успешно привязан к сделке по номеру телефона', [
                    'brief_id' => $brif->id,
                    'deal_id' => $availableDeal->id,
                    'client_phone' => $availableDeal->client_phone,
                    'normalized_client_phone' => preg_replace('/\D/', '', $availableDeal->client_phone)
                ]);
            } else {
                Log::info('Не найдено подходящих сделок без привязанных брифов для привязки общего брифа', [
                    'brief_id' => $brif->id,
                    'user_phone' => $user->phone,
                    'normalized_phone' => $normalizedPhone
                ]);
            }
        } else {
            Log::info('У пользователя не указан номер телефона, привязка брифа невозможна', [
                'user_id' => $user->id,
                'brief_id' => $brif->id
            ]);
        }
        
        return redirect()->route('common.questions', [
            'id'   => $brif->id,
            'page' => 0 // начинаем с нулевой страницы выбора комнат
        ]);
    }
    public function commercial_create()
    { $user = Auth::user();
        $title_site = "Создать Коммерческий бриф | Личный кабинет Экспресс-дизайн";
        return view('commercial.create',compact('title_site', 'user'));
    }
    /**
     * Отображение конкретного брифа.
     *
     * @param int $id
     * @return \Illuminate\Contracts\View\View
     */
    public function common_show($id)
    {
        $title_site = "Детали брифа | Личный кабинет Экспресс-дизайн";
        
        // Находим бриф
        $brif = Common::findOrFail($id);
        
        // Получаем владельца брифа вместо текущего пользователя
        $user = User::find($brif->user_id);
        
        // Если пользователь не найден, используем текущего пользователя как запасной вариант
        if (!$user) {
            $user = Auth::user();
        }
        
        $pageTitlesCommon = [
            'Общая информация',
            'Интерьер: стиль и предпочтения',
            'Пожелания по помещениям',
            'Пожелания по отделке помещений',
            'Пожелания по оснащению помещений',
        ];
        $questions = [
            1 => [
                ['key' => 'question_1_1', 'title' => 'Сколько человек будет проживать в квартире?', 'subtitle' => 'Укажите количество жильцов, их пол и возраст для понимания потребностей каждого члена семьи', 'type' => 'textarea', 'placeholder' => 'Пример: семейная пара с ребенком (0 лет), в будущем планируем еще детей', 'format' => 'default'],
                ['key' => 'question_1_2', 'title' => 'Есть ли у вас домашние животные и комнатные растения?', 'subtitle' => 'Укажите вид и количество животных или растений, чтобы мы могли учесть их потребности при проектировании пространства.', 'type' => 'textarea', 'placeholder' => 'Пример: среднеразмерная собака бигль. Хотелось бы, чтобы напольное покрытие приглушало стук когтей, требуется место под лежанку и лапомойку на входе, место для еды. Растения в доме нужны, частично перевезем из старой квартиры, но хотелось бы еще добавить', 'format' => 'default'],
                ['key' => 'question_1_3', 'title' => 'Есть ли у членов семьи особые увлечения или хобби?', 'subtitle' => 'Укажите ( любимое занятие ,которое подразумевает в квартире особое место, к примеру полочки для хранения или выставки коллекции, место для швейной машинки и место для хранения принадлежностей для шитья). Это поможет нам создать функциональное пространство, соответствующее интересам и потребностям ваших близких', 'type' => 'textarea', 'placeholder' => 'Пример: Нужны зоны для хобби: место под электрогитару, усилитель и синтезатор, большой книжный шкаф', 'format' => 'default'],
                ['key' => 'question_1_4', 'title' => 'Требуется ли перепланировка? Каков состав помещений?', 'subtitle' => 'Опишите, какие изменения в планировке вы хотите осуществить.', 'type' => 'textarea', 'placeholder' => 'Пример: совместить кухню с гостиной. Спальня с гардеробной, детская, кабинет, кладовая, санузел', 'format' => 'default'],
                ['key' => 'question_1_5', 'title' => 'Как часто вы встречаете гостей?', 'subtitle' => 'Укажите, требуется ли предусмотреть дополнительные посадочные и спальные места и как часто вы ожидаете гостей', 'type' => 'textarea', 'placeholder' => 'Пример: Раз в месяц-два, на пару дней ', 'format' => 'default'],
                ['key' => 'question_1_6', 'title' => 'Адрес', 'subtitle' => 'Укажите адрес объекта (город, улица и дом, если есть - название ЖК)', 'type' => 'textarea', 'placeholder' => 'Пример: г. Грозный, ул. Лорсанова 15', 'format' => 'default'],
            ],
            2 => [
                ['key' => 'question_2_1', 'title' => 'Какой стиль Вы хотите видеть в своем интерьере? Какие цвета должны преобладать в интерьере?', 'subtitle' => 'Укажите предпочтения по стилям (например, современный, классический, минимализм) и цветам, которые вы хотите использовать в интерьере.', 'type' => 'textarea', 'placeholder' => 'Укажите предпочтения по стилям (например, современный, классический, минимализм) и цветам, которые вы хотите использовать в интерьере.', 'format' => 'default'],
             
                ['key' => 'question_2_2', 'title' => 'Какие имеющиеся предметы обстановки нужно включить в новый интерьер?', 'subtitle' => 'Перечислите мебель и аксессуары, которые вы хотите сохранить', 'type' => 'textarea', 'placeholder' => 'Перечислите мебель и аксессуары, которые вы хотите сохранить', 'format' => 'default'],
                ['key' => 'question_2_3', 'title' => 'В каком ценовом сегменте предполагается ремонт?', 'subtitle' => 'Укажите выбранный ценовой сегмент: эконом, средний+, бизнес или премиум', 'type' => 'textarea', 'placeholder' => 'Укажите выбранный ценовой сегмент: эконом, средний+, бизнес или премиум', 'format' => 'default'],
                ['key' => 'question_2_4', 'title' => 'Что не должно быть в вашем интерьере?', 'subtitle' => 'Перечислите элементы или материалы, которые вы не хотите видеть', 'type' => 'textarea', 'placeholder' => 'Перечислите элементы или материалы, которые вы не хотите видеть', 'format' => 'default'],
                ['key' => 'question_2_5', 'title' => 'Бюджет проекта', 'subtitle' => 'Укажите ориентировочную сумму бюджета, которую вы готовы потратить на ремонт, включая стоимость материалов', 'type' => 'textarea', 'placeholder' => 'Укажите ориентировочную сумму бюджета, которую вы готовы потратить на ремонт, включая стоимость материалов', 'format' => 'default'],
            ],
            3 => [ // Комнаты будут отфильтрованы позже на основе выбора на странице 0
                ['key' => 'question_3_1', 'title' => 'Прихожая', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в прихожей? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_2', 'title' => 'Детская', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в детской? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_3', 'title' => 'Кладовая', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в кладовой? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_4', 'title' => 'Кухня и гостиная', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в кухне и гостиной? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_5', 'title' => 'Гостевой санузел', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Перечислите предпочтения по выбору душа, раковины с тумбой, унитаза и других элементов.', 'format' => 'faq'],
                ['key' => 'question_3_6', 'title' => 'Гостиная', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в гостиной? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_7', 'title' => 'Рабочее место', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в рабочей зоне? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_8', 'title' => 'Столовая', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в столовой? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_9', 'title' => 'Ванная комната', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Укажите предпочтения по выбору ванны/душа, раковины с тумбой, унитаза, полотенцесушителя и стиральной машины.', 'format' => 'faq'],
                ['key' => 'question_3_10', 'title' => 'Кухня', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Укажите тип плиты, наличие посудомоечной машины, микроволновой печи, духового шкафа, мойки, холодильника и других приборов. Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_11', 'title' => 'Кабинет', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в кабинете? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_12', 'title' => 'Спальня', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в спальне? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_13', 'title' => 'Гардеробная', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в гардеробной? Опишите детали и расстановку мебели.', 'format' => 'faq'],
                ['key' => 'question_3_14', 'title' => 'Другое', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какие пожелания у вас есть по наполнению в других помещениях? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ],
            4 => [
                ['key' => 'question_4_1', 'title' => 'Напольные покрытия', 'subtitle' => 'Укажите, какие материалы вы предпочитаете (ламинат, паркет, плитка и т.д.) и в каких помещениях они будут использоваться', 'type' => 'textarea', 'placeholder' => 'Укажите, какие материалы вы предпочитаете (ламинат, паркет, плитка и т.д.) и в каких помещениях они будут использоваться', 'format' => 'default'],
                ['key' => 'question_4_2', 'title' => 'Двери', 'subtitle' => 'Опишите ваши пожелания относительно дверей: обычные, складные, раздвижные, распашные, стеклянные перегородки, скрытого монтажа, нестандартной высоты, стеклянные и т п', 'type' => 'textarea', 'placeholder' => 'Опишите ваши пожелания относительно дверей: обычные, складные, раздвижные, распашные, стеклянные перегородки, скрытого монтажа, нестандартной высоты, стеклянные и т.п.', 'format' => 'default'],
                ['key' => 'question_4_3', 'title' => 'Отделка стен', 'subtitle' => 'Опишите ваши пожелания по материалам (обои, краска, декоративная штукатурка) и стилю оформления стен', 'type' => 'textarea', 'placeholder' => 'Опишите ваши пожелания по материалам (обои, краска, декоративная штукатурка) и стилю оформления стен', 'format' => 'default'],
                ['key' => 'question_4_4', 'title' => 'Освещение и электрика', 'subtitle' => 'Укажите, какие типы освещения вам нравятся (встраиваемые светильники, люстры, бра) и в каких зонах они должны быть установлены', 'type' => 'textarea', 'placeholder' => 'Укажите, какие типы освещения вам нравятся (встраиваемые светильники, люстры, бра) и в каких зонах они должны быть установлены', 'format' => 'default'],
                ['key' => 'question_4_5', 'title' => 'Потолки', 'subtitle' => 'Укажите, хотите ли вы использовать натяжные потолки, гипсокартонные конструкции или оставить стандартные потолки', 'type' => 'textarea', 'placeholder' => 'Укажите, хотите ли вы использовать натяжные потолки, гипсокартонные конструкции или оставить стандартные потолки', 'format' => 'default'],
                ['key' => 'question_4_6', 'title' => 'Дополнительные пожелания', 'subtitle' => 'Перечислите все моменты, которые вы считаете важными по отделке', 'type' => 'textarea', 'placeholder' => 'Перечислите все моменты, которые вы считаете важными по отделке', 'format' => 'default'],
            ],
            5 => [
                ['key' => 'question_5_1', 'title' => 'Пожелания по звукоизоляции', 'subtitle' => 'Уточните, какие источники шума вас беспокоят и в каких зонах вы хотели бы улучшить звукоизоляцию', 'type' => 'textarea', 'placeholder' => 'Уточните, какие источники шума вас беспокоят и в каких зонах вы хотели бы улучшить звукоизоляцию', 'format' => 'default'],
                ['key' => 'question_5_2', 'title' => 'Теплые полы', 'subtitle' => 'Укажите, предпочитаете ли вы электрические или водяные теплые полы, а также в каких помещениях они должны быть установлены ', 'type' => 'textarea', 'placeholder' => 'Укажите, предпочитаете ли вы электрические или водяные теплые полы, а также в каких помещениях они должны быть установлены', 'format' => 'default'],
                ['key' => 'question_5_3', 'title' => 'Предпочтения по размещению и типу радиаторов', 'subtitle' => 'Укажите, хотите ли вы заменить стандартные радиаторы на более современные или изменить их расположение', 'type' => 'textarea', 'placeholder' => 'Укажите, хотите ли вы заменить стандартные радиаторы на более современные или изменить их расположение', 'format' => 'default'],
                ['key' => 'question_5_4', 'title' => 'Водоснабжение', 'subtitle' => 'Опишите ваши пожелания по установке фильтров очистки воды, водонагревателей и других элементов системы водоснабжения', 'type' => 'textarea', 'placeholder' => 'Опишите ваши пожелания по установке фильтров очистки воды, водонагревателей и других элементов системы водоснабжения', 'format' => 'default'],
                ['key' => 'question_5_5', 'title' => 'Кондиционирование и вентиляция', 'subtitle' => 'Пропишите зоны для установки систем вентиляции и кондиционирования', 'type' => 'textarea', 'placeholder' => 'Пропишите зоны для установки систем вентиляции и кондиционирования', 'format' => 'default'],
                ['key' => 'question_5_6', 'title' => 'Сети', 'subtitle' => 'Укажите, в каких помещениях необходимы розетки для интернета и телевидения, а также интересуют ли вас системы "умный дом", сигнализация и другие современные технологии.', 'type' => 'textarea', 'placeholder' => 'Укажите, в каких помещениях необходимы розетки для интернета и телевидения, а также интересуют ли вас системы "умный дом", сигнализация и другие современные технологии', 'format' => 'default'],
            ],
        ];
        
        // Находим бриф
        $brif = Common::findOrFail($id);
    
        // Проверяем, является ли пользователь ответственным за сделку
        $deal = Deal::find($brif->deal_id);
       
    
        // Если бриф активен, перенаправляем на страницу с вопросами
        if ($brif->status === 'Активный') {
            return redirect()->route('common.questions', $brif->current_page);
        }
        // Получение документов и фотографий
        $documentsPath = storage_path("app/public/brifs/{$id}/documents");
        $photosPath = storage_path("app/public/brifs/{$id}/photos");
    
        $documents = file_exists($documentsPath) ? array_diff(scandir($documentsPath), ['.', '..']) : [];
        $photos = file_exists($photosPath) ? array_diff(scandir($photosPath), ['.', '..']) : [];
    
        // Фильтруем вопросы для комнат (страница 3) на основе выбранных комнат
        $selectedRooms = json_decode($brif->rooms, true) ?? [];
        if (!empty($selectedRooms) && isset($questions[3])) {
            $roomTitles = array_values($selectedRooms);
            $questions[3] = array_filter($questions[3], function($question) use ($roomTitles) {
                if ($question['format'] == 'faq') {
                    foreach ($roomTitles as $roomTitle) {
                        if ($question['title'] == $roomTitle || $question['title'] == 'Другое') {
                            return true;
                        }
                    }
                    return false;
                }
                return true;
            });
        }
    
        return view('common.show', compact(
            'brif', 'user', 'title_site', 'pageTitlesCommon', 'questions', 'documents', 'photos'
        ));
    }
    
    public function commercial_show($id)
    {
        $title_site = "Детали брифа | Личный кабинет Экспресс-дизайн";
        
        // Находим коммерческий бриф
        $brif = Commercial::findOrFail($id);
        
        // Получаем владельца брифа вместо текущего пользователя
        $user = User::find($brif->user_id);
        
        // Если пользователь не найден, используем текущего пользователя как запасной вариант
        if (!$user) {
            $user = Auth::user();
        }
    
        // Проверяем, является ли пользователь ответственным за сделку
        $deal = Deal::find($brif->deal_id);
    
        // Получаем дополнительные данные, такие как зоны и предпочтения
        $zones = $brif && $brif->zones ? json_decode($brif->zones, true) : [];
        $preferences = $brif && $brif->preferences ? json_decode($brif->preferences, true) : [];
        $documents = $brif && $brif->documents ? json_decode($brif->documents, true) : []; // Декодируем документы
    
        // Вопросы для отображения
        $questions = [
            'zone_1' => "Зоны и их функционал",
            'zone_2' => "Метраж зон",
            'zone_3' => "Зоны и их стиль оформления",
            'zone_4' => "Мебилировка зон",
            'zone_5' => "Предпочтения отделочных материалов",
            'zone_6' => "Освещение зон",
            'zone_7' => "Кондиционирование зон",
            'zone_8' => "Напольное покрытие зон",
            'zone_9' => "Отделка стен зон",
            'zone_10' => "Отделка потолков зон",
            'zone_11' => "Категорически неприемлемо или нет",
            'zone_12' => "Бюджет на помещения",
            'zone_13' => "Пожелания и комментарии",
        ];
    
        // Формируем предпочтения с названиями вопросов
        $preferencesFormatted = [];
        foreach ($zones as $index => $zone) {
            $zoneName = $zone['name'] ?? "Без названия"; // Берем название зоны
            $preferencesFormatted[$zoneName] = [];      // Используем его как ключ
            if (isset($preferences["zone_$index"])) {
                foreach ($preferences["zone_$index"] as $questionKey => $answer) {
                    $questionNumber = str_replace('question_', '', $questionKey);
                    $questionTitle = $questions[$questionNumber] ?? "Вопрос $questionNumber";
                    $preferencesFormatted[$zoneName][] = [
                        'question' => $questionTitle,
                        'answer' => $answer,
                    ];
                }
            }
        }
    
        return view('commercial.show', compact('brif', 'user', 'title_site', 'zones', 'preferencesFormatted', 'documents'));
    }
        
    public function commercial_store(Request $request)
    {
        $user = Auth::user();
        
        // Создаем бриф
        $brif = Commercial::create([
            'title' => 'Коммерческий бриф',
            'description' => 'Коммерческий бриф ориентирован на детальную проработку проектов для коммерческих объектов. В его рамках рассматриваются вопросы, связанные с функциональностью, зонированием, метражами, отделкой и техническими требованиями помещений. Вы указываете предпочтения по материалам, мебельной компоновке, освещению и системам кондиционирования, а также устанавливаете бюджет проекта. Такой бриф помогает разработать комплексное решение, отвечающее высоким стандартам эффективности, комфорта и эстетики, что особенно важно для коммерческих пространств.',
            'status' => 'Активный',
            'article' => Str::random(15),
            'user_id' => $user->id,
        ]);
        
        // Ищем сделки по номеру телефона пользователя без привязанных брифов любого типа
        if ($user->phone) {
            // Нормализуем телефон для поиска (убираем все нецифровые символы)
            $normalizedPhone = preg_replace('/\D/', '', $user->phone);
            
            Log::info('Поиск сделки для привязки коммерческого брифа', [
                'user_id' => $user->id,
                'normalized_phone' => $normalizedPhone,
                'brief_id' => $brif->id
            ]);
            
            // Вместо использования REGEXP, получим все сделки без привязанных брифов ЛЮБОГО ТИПА
            $potentialDeals = Deal::whereNull('commercial_id')
                             ->whereNull('common_id') // Добавляем проверку на отсутствие общего брифа
                             ->get();
        
            // Ищем сделку с совпадающим номером телефона
            $availableDeal = null;
            foreach ($potentialDeals as $deal) {
                $dealPhoneNormalized = preg_replace('/\D/', '', $deal->client_phone);
                
                // Сравниваем последние N цифр телефона (например, 10 для России)
                $lastDigitsToCompare = 10;
                $dealLastDigits = substr($dealPhoneNormalized, -$lastDigitsToCompare);
                $userLastDigits = substr($normalizedPhone, -$lastDigitsToCompare);
                
                if ($dealLastDigits == $userLastDigits && strlen($dealLastDigits) == $lastDigitsToCompare) {
                    $availableDeal = $deal;
                    break;
                }
            }
            
            // Если нашли подходящую сделку, привязываем к ней бриф
            if ($availableDeal) {
                // Используем транзакцию для атомарного обновления
                \DB::transaction(function() use ($availableDeal, $brif) {
                    // Привязываем бриф к сделке
                    $availableDeal->commercial_id = $brif->id;
                    $availableDeal->save();
                    
                    // Привязываем сделку к брифу
                    $brif->deal_id = $availableDeal->id;
                    $brif->save();
                });
                
                // Логируем привязку
                Log::info('Коммерческий бриф успешно привязан к сделке по номеру телефона', [
                    'brief_id' => $brif->id,
                    'deal_id' => $availableDeal->id,
                    'client_phone' => $availableDeal->client_phone,
                    'normalized_client_phone' => preg_replace('/\D/', '', $availableDeal->client_phone)
                ]);
            } else {
                Log::info('Не найдено подходящих сделок без привязанных брифов для привязки коммерческого брифа', [
                    'brief_id' => $brif->id,
                    'user_phone' => $user->phone,
                    'normalized_phone' => $normalizedPhone
                ]);
            }
        } else {
            Log::info('У пользователя не указан номер телефона, привязка брифа невозможна', [
                'user_id' => $user->id,
                'brief_id' => $brif->id
            ]);
        }
        
        return redirect()->route('commercial.questions', [
            'id'   => $brif->id,
            'page' => 1
        ]);
       
    }
    /**
     * Отображение конкретного брифа.
     *
     * @param int $id
     * @return \Illuminate\Contracts\View\View
     */
    public function store(Request $request)
    {
        // Увеличиваем лимит времени выполнения скрипта
        set_time_limit(300);
    
        $type = $request->input('brif_type');
    
        if ($type === 'common') {
            // Создание общего брифа
            $brif = Common::create([
                'title'       => 'Общий бриф',
                'description' => 'Общий бриф представляет собой структурированный опрос, направленный на выявление базовых предпочтений и потребностей клиента. Он включает вопросы о личных предпочтениях, функциональных особенностях помещения, количестве жильцов, а также об основных стилевых решениях. Заполнение этого брифа позволяет нам лучше понять ваш образ жизни и создать проект, который гармонично объединит практичность, уют и эстетическое единство интерьера.',
                'status'      => 'Активный',
                'article'     => Str::random(15),
                'user_id'     => auth()->id(),
            ]);
    
            return redirect()->route('common.questions', [
                'id'   => $brif->id,
                'page' => 0 // изменено: перенаправление на страницу выбора комнат
            ]);
        } elseif ($type === 'commercial') {
            // Создание коммерческого брифа
            $brif = Commercial::create([
                'title'       => 'Коммерческий бриф',
                'description' => 'Коммерческий бриф ориентирован на детальную проработку проектов для коммерческих объектов. В его рамках рассматриваются вопросы, связанные с функциональностью, зонированием, метражами, отделкой и техническими требованиями помещений. Вы указываете предпочтения по материалам, мебельной компоновке, освещению и системам кондиционирования, а также устанавливаете бюджет проекта. Такой бриф помогает разработать комплексное решение, отвечающее высоким стандартам эффективности, комфорта и эстетики, что особенно важно для коммерческих пространств.',
                'status'      => 'Активный',
                'article'     => Str::random(15),
                'user_id'     => auth()->id(),
            ]);
    
            return redirect()->route('commercial.questions', [
                'id'   => $brif->id,
                'page' => 1
            ]);
        }
    
        // На случай, если по каким-то причинам brif_type не отправилось
        return redirect()->back()->with('error', 'Не удалось определить тип брифа.');
    }
    public function destroy($id)
{
    // Попытка найти бриф среди Общих и Коммерческих
    $brif = \App\Models\Common::find($id) ?: \App\Models\Commercial::find($id);
    
    // Проверяем, принадлежит ли бриф текущему пользователю
    if ($brif && $brif->user_id == auth()->id()) {
        $brif->delete();
        return redirect()->back()->with('success', 'Бриф успешно удалён');
    }
    
    return redirect()->back()->with('error', 'Удалить бриф не удалось');
}

/**
 * Скачать PDF-версию общего брифа
 *
 * @param int $id
 * @return \Illuminate\Http\Response
 */
public function common_download_pdf($id)
{
    $title_site = "Общий бриф | PDF";
    
    // Находим бриф
    $brif = Common::findOrFail($id);
    
    // Получаем владельца брифа вместо текущего пользователя
    $user = User::find($brif->user_id);
    
    // Если пользователь не найден, используем текущего пользователя как запасной вариант
    if (!$user) {
        $user = Auth::user();
    }
    
    $pageTitlesCommon = [
        'Общая информация',
        'Интерьер: стиль и предпочтения',
        'Пожелания по помещениям',
        'Пожелания по отделке помещений',
        'Пожелания по оснащению помещений',
    ];
    
    // Определяем полный массив вопросов для новой структуры из 5 страниц
    $questions = [
        1 => [
            ['key' => 'question_1_1', 'title' => 'Сколько человек будет проживать в квартире?', 'subtitle' => 'Укажите количество жильцов, их пол и возраст для понимания потребностей каждого члена семьи', 'type' => 'textarea', 'placeholder' => 'Пример: семейная пара с ребенком (0 лет), в будущем планируем еще детей', 'format' => 'default'],
            ['key' => 'question_1_2', 'title' => 'Есть ли у вас домашние животные и комнатные растения?', 'subtitle' => 'Укажите вид и количество животных или растений, чтобы мы могли учесть их потребности при проектировании пространства.', 'type' => 'textarea', 'placeholder' => 'Пример: среднеразмерная собака бигль. Хотелось бы, чтобы напольное покрытие приглушало стук когтей, требуется место под лежанку и лапомойку на входе, место для еды. Растения в доме нужны, частично перевезем из старой квартиры, но хотелось бы еще добавить', 'format' => 'default'],
            ['key' => 'question_1_3', 'title' => 'Есть ли у членов семьи особые увлечения или хобби?', 'subtitle' => 'Укажите ( любимое занятие ,которое подразумевает в квартире особое место, к примеру полочки для хранения или выставки коллекции, место для швейной машинки и место для хранения принадлежностей для шитья). Это поможет нам создать функциональное пространство, соответствующее интересам и потребностям ваших близких', 'type' => 'textarea', 'placeholder' => 'Пример: Нужны зоны для хобби: место под электрогитару, усилитель и синтезатор, большой книжный шкаф', 'format' => 'default'],
            ['key' => 'question_1_4', 'title' => 'Требуется ли перепланировка? Каков состав помещений?', 'subtitle' => 'Опишите, какие изменения в планировке вы хотите осуществить.', 'type' => 'textarea', 'placeholder' => 'Пример: совместить кухню с гостиной. Спальня с гардеробной, детская, кабинет, кладовая, санузел', 'format' => 'default'],
            ['key' => 'question_1_5', 'title' => 'Как часто вы встречаете гостей?', 'subtitle' => 'Укажите, требуется ли предусмотреть дополнительные посадочные и спальные места и как часто вы ожидаете гостей', 'type' => 'textarea', 'placeholder' => 'Пример: Раз в месяц-два, на пару дней ', 'format' => 'default'],
            ['key' => 'question_1_6', 'title' => 'Адрес', 'subtitle' => 'Укажите адрес объекта (город, улица и дом, если есть - название ЖК)', 'type' => 'textarea', 'placeholder' => 'Пример: г. Грозный, ул. Лорсанова 15', 'format' => 'default'],
        ],
        2 => [
            ['key' => 'question_2_1', 'title' => 'Какой стиль Вы хотите видеть в своем интерьере? Какие цвета должны преобладать в интерьере?', 'subtitle' => 'Укажите предпочтения по стилям (например, современный, классический, минимализм) и цветам, которые вы хотите использовать в интерьере.', 'type' => 'textarea', 'placeholder' => 'Укажите предпочтения по стилям (например, современный, классический, минимализм) и цветам, которые вы хотите использовать в интерьере.', 'format' => 'default'],
         
            ['key' => 'question_2_2', 'title' => 'Какие имеющиеся предметы обстановки нужно включить в новый интерьер?', 'subtitle' => 'Перечислите мебель и аксессуары, которые вы хотите сохранить', 'type' => 'textarea', 'placeholder' => 'Перечислите мебель и аксессуары, которые вы хотите сохранить', 'format' => 'default'],
            ['key' => 'question_2_3', 'title' => 'В каком ценовом сегменте предполагается ремонт?', 'subtitle' => 'Укажите выбранный ценовой сегмент: эконом, средний+, бизнес или премиум', 'type' => 'textarea', 'placeholder' => 'Укажите выбранный ценовой сегмент: эконом, средний+, бизнес или премиум', 'format' => 'default'],
            ['key' => 'question_2_4', 'title' => 'Что не должно быть в вашем интерьере?', 'subtitle' => 'Перечислите элементы или материалы, которые вы не хотите видеть', 'type' => 'textarea', 'placeholder' => 'Перечислите элементы или материалы, которые вы не хотите видеть', 'format' => 'default'],
            ['key' => 'question_2_5', 'title' => 'Бюджет проекта', 'subtitle' => 'Укажите ориентировочную сумму бюджета, которую вы готовы потратить на ремонт, включая стоимость материалов', 'type' => 'textarea', 'placeholder' => 'Укажите ориентировочную сумму бюджета, которую вы готовы потратить на ремонт, включая стоимость материалов', 'format' => 'default'],
        ],
        3 => [ // Комнаты будут отфильтрованы позже на основе выбора на странице 0
            ['key' => 'question_3_1', 'title' => 'Прихожая', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в прихожей? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_2', 'title' => 'Детская', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в детской? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_3', 'title' => 'Кладовая', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в кладовой? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_4', 'title' => 'Кухня и гостиная', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в кухне и гостиной? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_5', 'title' => 'Гостевой санузел', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Перечислите предпочтения по выбору душа, раковины с тумбой, унитаза и других элементов.', 'format' => 'faq'],
            ['key' => 'question_3_6', 'title' => 'Гостиная', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в гостиной? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_7', 'title' => 'Рабочее место', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в рабочей зоне? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_8', 'title' => 'Столовая', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в столовой? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_9', 'title' => 'Ванная комната', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Укажите предпочтения по выбору ванны/душа, раковины с тумбой, унитаза, полотенцесушителя и стиральной машины.', 'format' => 'faq'],
            ['key' => 'question_3_10', 'title' => 'Кухня', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Укажите тип плиты, наличие посудомоечной машины, микроволновой печи, духового шкафа, мойки, холодильника и других приборов. Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_11', 'title' => 'Кабинет', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в кабинете? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_12', 'title' => 'Спальня', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в спальне? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_13', 'title' => 'Гардеробная', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какую мебель и оборудование вы планируете разместить в гардеробной? Опишите детали и расстановку мебели.', 'format' => 'faq'],
            ['key' => 'question_3_14', 'title' => 'Другое', 'subtitle' => 'Пожелания по наполнению и дизайну', 'type' => 'textarea', 'placeholder' => 'Какие пожелания у вас есть по наполнению в других помещениях? Опишите детали и расстановку мебели.', 'format' => 'faq'],
        ],
        4 => [
            ['key' => 'question_4_1', 'title' => 'Напольные покрытия', 'subtitle' => 'Укажите, какие материалы вы предпочитаете (ламинат, паркет, плитка и т.д.) и в каких помещениях они будут использоваться', 'type' => 'textarea', 'placeholder' => 'Укажите, какие материалы вы предпочитаете (ламинат, паркет, плитка и т.д.) и в каких помещениях они будут использоваться', 'format' => 'default'],
            ['key' => 'question_4_2', 'title' => 'Двери', 'subtitle' => 'Опишите ваши пожелания относительно дверей: обычные, складные, раздвижные, распашные, стеклянные перегородки, скрытого монтажа, нестандартной высоты, стеклянные и т п', 'type' => 'textarea', 'placeholder' => 'Опишите ваши пожелания относительно дверей: обычные, складные, раздвижные, распашные, стеклянные перегородки, скрытого монтажа, нестандартной высоты, стеклянные и т.п.', 'format' => 'default'],
            ['key' => 'question_4_3', 'title' => 'Отделка стен', 'subtitle' => 'Опишите ваши пожелания по материалам (обои, краска, декоративная штукатурка) и стилю оформления стен', 'type' => 'textarea', 'placeholder' => 'Опишите ваши пожелания по материалам (обои, краска, декоративная штукатурка) и стилю оформления стен', 'format' => 'default'],
            ['key' => 'question_4_4', 'title' => 'Освещение и электрика', 'subtitle' => 'Укажите, какие типы освещения вам нравятся (встраиваемые светильники, люстры, бра) и в каких зонах они должны быть установлены', 'type' => 'textarea', 'placeholder' => 'Укажите, какие типы освещения вам нравятся (встраиваемые светильники, люстры, бра) и в каких зонах они должны быть установлены', 'format' => 'default'],
            ['key' => 'question_4_5', 'title' => 'Потолки', 'subtitle' => 'Укажите, хотите ли вы использовать натяжные потолки, гипсокартонные конструкции или оставить стандартные потолки', 'type' => 'textarea', 'placeholder' => 'Укажите, хотите ли вы использовать натяжные потолки, гипсокартонные конструкции или оставить стандартные потолки', 'format' => 'default'],
            ['key' => 'question_4_6', 'title' => 'Дополнительные пожелания', 'subtitle' => 'Перечислите все моменты, которые вы считаете важными по отделке', 'type' => 'textarea', 'placeholder' => 'Перечислите все моменты, которые вы считаете важными по отделке', 'format' => 'default'],
        ],
        5 => [
            ['key' => 'question_5_1', 'title' => 'Пожелания по звукоизоляции', 'subtitle' => 'Уточните, какие источники шума вас беспокоят и в каких зонах вы хотели бы улучшить звукоизоляцию', 'type' => 'textarea', 'placeholder' => 'Уточните, какие источники шума вас беспокоят и в каких зонах вы хотели бы улучшить звукоизоляцию', 'format' => 'default'],
            ['key' => 'question_5_2', 'title' => 'Теплые полы', 'subtitle' => 'Укажите, предпочитаете ли вы электрические или водяные теплые полы, а также в каких помещениях они должны быть установлены ', 'type' => 'textarea', 'placeholder' => 'Укажите, предпочитаете ли вы электрические или водяные теплые полы, а также в каких помещениях они должны быть установлены', 'format' => 'default'],
            ['key' => 'question_5_3', 'title' => 'Предпочтения по размещению и типу радиаторов', 'subtitle' => 'Укажите, хотите ли вы заменить стандартные радиаторы на более современные или изменить их расположение', 'type' => 'textarea', 'placeholder' => 'Укажите, хотите ли вы заменить стандартные радиаторы на более современные или изменить их расположение', 'format' => 'default'],
            ['key' => 'question_5_4', 'title' => 'Водоснабжение', 'subtitle' => 'Опишите ваши пожелания по установке фильтров очистки воды, водонагревателей и других элементов системы водоснабжения', 'type' => 'textarea', 'placeholder' => 'Опишите ваши пожелания по установке фильтров очистки воды, водонагревателей и других элементов системы водоснабжения', 'format' => 'default'],
            ['key' => 'question_5_5', 'title' => 'Кондиционирование и вентиляция', 'subtitle' => 'Пропишите зоны для установки систем вентиляции и кондиционирования', 'type' => 'textarea', 'placeholder' => 'Пропишите зоны для установки систем вентиляции и кондиционирования', 'format' => 'default'],
            ['key' => 'question_5_6', 'title' => 'Сети', 'subtitle' => 'Укажите, в каких помещениях необходимы розетки для интернета и телевидения, а также интересуют ли вас системы "умный дом", сигнализация и другие современные технологии.', 'type' => 'textarea', 'placeholder' => 'Укажите, в каких помещениях необходимы розетки для интернета и телевидения, а также интересуют ли вас системы "умный дом", сигнализация и другие современные технологии', 'format' => 'default'],
        ],
    ];
    
    // Фильтруем вопросы для комнат (страница 3) на основе выбранных комнат
    $selectedRooms = json_decode($brif->rooms, true) ?? [];
    if (!empty($selectedRooms) && isset($questions[3])) {
        $roomTitles = array_values($selectedRooms);
        $questions[3] = array_filter($questions[3], function($question) use ($roomTitles) {
            if ($question['format'] == 'faq') {
                foreach ($roomTitles as $roomTitle) {
                    if ($question['title'] == $roomTitle || $question['title'] == 'Другое') {
                        return true;
                    }
                }
                return false;
            }
            return true;
        });
    }
    
    // Преобразуем ссылки на файлы в полные URL-адреса
    if ($brif->references) {
        $references = json_decode($brif->references, true) ?? [];
        foreach ($references as &$reference) {
            // Убедитесь, что ссылка абсолютная, а не относительная
            if (!Str::startsWith($reference, ['http://', 'https://', 'www.'])) {
                $reference = config('app.url') . '/' . ltrim($reference, '/');
            }
        }
        $brif->references = json_encode($references);
    }
    
    if ($brif->documents) {
        $documents = json_decode($brif->documents, true) ?? [];
        foreach ($documents as &$document) {
            // Убедитесь, что ссылка абсолютная, а не относительная
            if (!Str::startsWith($document, ['http://', 'https://', 'www.'])) {
                $document = config('app.url') . '/' . ltrim($document, '/');
            }
        }
        $brif->documents = json_encode($documents);
    }
    
    // Генерируем PDF из шаблона
    $pdf = PDF::loadView('common.pdf', [
        'brif' => $brif, 
        'user' => $user, 
        'pageTitlesCommon' => $pageTitlesCommon, 
        'questions' => $questions
    ]);
    
    // Устанавливаем кодировку UTF-8 для корректного отображения кириллицы
    $pdf->getDomPDF()->set_option('defaultFont', 'DejaVu Sans');
    $pdf->getDomPDF()->set_option('isRemoteEnabled', true);
    $pdf->getDomPDF()->set_option('isPhpEnabled', true);
    
    // Задаем имя файла для скачивания
    $filename = "common_brief_{$brif->id}.pdf";
    
    try {
        // Возвращаем PDF как скачиваемый файл
        return $pdf->download($filename);
    } catch (\Exception $e) {
        // Логируем ошибку
        \Illuminate\Support\Facades\Log::error('Ошибка генерации PDF для общего брифа: ' . $e->getMessage(), [
            'brif_id' => $brif->id,
            'trace' => $e->getTraceAsString()
        ]);
        
        return redirect()->back()->with('error', 'Не удалось сгенерировать PDF. Ошибка: ' . $e->getMessage());
    }
}

/**
 * Скачать PDF-версию коммерческого брифа
 *
 * @param int $id
 * @return \Illuminate\Http\Response
 */
public function commercial_download_pdf($id)
{
    $title_site = "Коммерческий бриф | PDF";
    
    // Находим коммерческий бриф
    $brif = Commercial::findOrFail($id);
    
    // Получаем владельца брифа вместо текущего пользователя
    $user = User::find($brif->user_id);
    
    // Если пользователь не найден, используем текущего пользователя как запасной вариант
    if (!$user) {
        $user = Auth::user();
    }
    
    // Получаем дополнительные данные для коммерческого брифа
    $zones = $brif->zones ? json_decode($brif->zones, true) : [];
    $preferences = $brif->preferences ? json_decode($brif->preferences, true) : [];
    $price = $brif->zone_budgets ? json_decode($brif->zone_budgets, true) : [];
    
    // Вопросы для отображения
    $questions = [
        'zone_1' => "Зоны и их функционал",
        'zone_2' => "Метраж зон",
        'zone_3' => "Зоны и их стиль оформления",
        'zone_4' => "Мебилировка зон",
        'zone_5' => "Предпочтения отделочных материалов",
        'zone_6' => "Освещение зон",
        'zone_7' => "Кондиционирование зон",
        'zone_8' => "Напольное покрытие зон",
        'zone_9' => "Отделка стен зон",
        'zone_10' => "Отделка потолков зон",
        'zone_11' => "Категорически неприемлемо или нет",
        'zone_12' => "Бюджет на помещения",
        'zone_13' => "Пожелания и комментарии",
    ];
    
    // Преобразуем ссылки на файлы в полные URL-адреса
    if ($brif->documents) {
        $documents = json_decode($brif->documents, true) ?? [];
        foreach ($documents as &$document) {
            // Убедитесь, что ссылка абсолютная, а не относительная
            if (!Str::startsWith($document, ['http://', 'https://', 'www.'])) {
                $document = config('app.url') . '/' . ltrim($document, '/');
            }
        }
        $brif->documents = json_encode($documents);
    }
    
    // Формируем предпочтения с названиями вопросов
    $preferencesFormatted = [];
    foreach ($zones as $index => $zone) {
        $zoneName = $zone['name'] ?? "Без названия";
        $preferencesFormatted[$zoneName] = [];
        if (isset($preferences["zone_$index"])) {
            foreach ($preferences["zone_$index"] as $questionKey => $answer) {
                $questionNumber = str_replace('question_', '', $questionKey);
                $questionTitle = $questions[$questionNumber] ?? "Вопрос $questionNumber";
                $preferencesFormatted[$zoneName][] = [
                    'question' => $questionTitle,
                    'answer' => $answer,
                ];
            }
        }
    }
    
    try {
        // Генерируем PDF из шаблона
        $pdf = PDF::loadView('commercial.pdf', [
            'brif' => $brif, 
            'user' => $user, 
            'zones' => $zones, 
            'preferencesFormatted' => $preferencesFormatted,
            'price' => $price
        ]);
        
        // Устанавливаем кодировку UTF-8 для корректного отображения кириллицы
        $pdf->getDomPDF()->set_option('defaultFont', 'DejaVu Sans');
        $pdf->getDomPDF()->set_option('isRemoteEnabled', true);
        $pdf->getDomPDF()->set_option('isPhpEnabled', true);
        
        // Задаем имя файла для скачивания
        $filename = "commercial_brief_{$brif->id}.pdf";
        
        // Возвращаем PDF как скачиваемый файл
        return $pdf->download($filename);
    } catch (\Exception $e) {
        // Логируем ошибку
        \Illuminate\Support\Facades\Log::error('Ошибка генерации PDF для коммерческого брифа: ' . $e->getMessage(), [
            'brif_id' => $brif->id,
            'trace' => $e->getTraceAsString()
        ]);
        
        return redirect()->back()->with('error', 'Не удалось сгенерировать PDF. Ошибка: ' . $e->getMessage());
    }
}
}
